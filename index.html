<script>
document.addEventListener("DOMContentLoaded", () => {

const LOC = { lat: 19.0760, lon: 72.8777 };

async function start() {
    try {
        const loading = document.getElementById("loading");

        const aqiURL = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LOC.lat}&longitude=${LOC.lon}&current=pm2_5`;
        const sunURL = `https://api.open-meteo.com/v1/forecast?latitude=${LOC.lat}&longitude=${LOC.lon}&daily=sunrise,sunset&timezone=auto&forecast_days=30`;

        const aqiRes = await fetch(aqiURL);
        const sunRes = await fetch(sunURL);

        const aqiData = await aqiRes.json();
        const sunData = await sunRes.json();

        if (!aqiData.current || !sunData.daily) throw "API failed";

        // Sunrise Sunset
        const formatTime = t => new Date(t).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        document.getElementById("sr").innerText = formatTime(sunData.daily.sunrise[0]);
        document.getElementById("ss").innerText = formatTime(sunData.daily.sunset[0]);

        // AQI
        const pm25 = aqiData.current.pm2_5 ?? "--";
        document.getElementById("aqi").innerText = pm25;

        const msg = document.getElementById("aqi-msg");
        if (pm25 <= 12) msg.innerText="SAFE (GOOD)";
        else if (pm25 <= 35) msg.innerText="MODERATE";
        else msg.innerText="UNHEALTHY";

        runCountdown(sunData.daily.sunrise[0], sunData.daily.sunset[0], sunData.daily.sunrise[1]);

        renderChart(sunData.daily.sunrise, sunData.daily.sunset);

        loading.style.display="none";

    } catch(e) {
        console.log(e);
        document.getElementById("loading").innerText="API / Network Error";
    }
}

function renderChart(srArr, ssArr) {
    const ctx = document.getElementById("solarChart");

    const labels = srArr.map(d => new Date(d).toLocaleDateString([], {month:"short", day:"numeric"}));
    const toDec = iso => { const d=new Date(iso); return d.getHours()+d.getMinutes()/60; };

    new Chart(ctx, {
        type:"line",
        data:{
            labels,
            datasets:[
                {label:"Sunset", data:ssArr.map(toDec), borderColor:"#f59e0b", fill:true},
                {label:"Sunrise", data:srArr.map(toDec), borderColor:"#3b82f6"}
            ]
        }
    });
}

function runCountdown(sr, ss, nextSr) {
    setInterval(()=>{
        const now=new Date();
        const sunrise=new Date(sr);
        const sunset=new Date(ss);

        let target = now<sunrise ? sunrise : now<sunset ? sunset : new Date(nextSr);
        let diff=target-now;

        if(diff<0) return;

        const h=Math.floor(diff/3600000).toString().padStart(2,"0");
        const m=Math.floor(diff%3600000/60000).toString().padStart(2,"0");
        const s=Math.floor(diff%60000/1000).toString().padStart(2,"0");

        document.getElementById("cd").innerText=`${h}:${m}:${s}`;
    },1000);
}

start();

});
</script>
