<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar & AQI Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --accent: #f59e0b; --card: #ffffff; --text: #1e293b; }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; padding: 30px 0; }
        .header h1 { margin: 0; font-size: 2.5rem; letter-spacing: 2px; }
        .header .city { color: var(--accent); font-weight: bold; font-size: 1.4rem; margin-top: 5px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .stat { font-size: 2.5rem; font-weight: 900; margin: 10px 0; color: var(--bg); }
        .label { color: #64748b; text-transform: uppercase; font-size: 0.8rem; font-weight: 800; letter-spacing: 1px; }
        .chart-box { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        #loader { position: fixed; inset: 0; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div id="loader">
    <div id="loader-text">üì° Syncing Satellite Data...</div>
    <button id="force-btn" class="btn" style="display:none;" onclick="useOfflineData()">Use Offline Estimates</button>
</div>

<div class="container">
    <div class="header">
        <h1>‡•ê ‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§æ‡§Ø ‡§®‡§Æ‡§É</h1>
        <div class="city">MUMBAI</div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="label">Solar Cycle (Today)</div>
            <div style="display:flex; justify-content: space-around; margin-top:15px;">
                <div><small class="label" style="font-size:0.6rem">Sunrise</small><div id="sr" style="font-weight:900; font-size:1.4rem;">--:--</div></div>
                <div><small class="label" style="font-size:0.6rem">Sunset</small><div id="ss" style="font-weight:900; font-size:1.4rem;">--:--</div></div>
            </div>
        </div>
        <div class="card">
            <div class="label">Air Quality (PM2.5)</div>
            <div class="stat" id="aqi">--</div>
            <div id="aqi-msg" style="font-weight:bold; font-size:0.8rem;">REFRESHING...</div>
        </div>
        <div class="card">
            <div class="label" id="cd-label">Countdown</div>
            <div class="stat" id="cd" style="color: var(--accent);">00:00:00</div>
        </div>
    </div>

    <div class="chart-box">
        <div class="label" style="margin-bottom:15px;">üìä 30-Day Solar Outlook (Sunrise to Sunset)</div>
        <canvas id="solarChart" height="110"></canvas>
    </div>
</div>

<script>
const LOC = { lat: 19.0760, lon: 72.8777 };

async function init() {
    try {
        // Step 1: Fetch Today's Data (Reliable Source)
        const sunRes = await fetch(`https://api.sunrise-sunset.org/json?lat=${LOC.lat}&lng=${LOC.lon}&formatted=0`);
        const sunData = await sunRes.json();
        
        // Step 2: Fetch AQI
        const aqiRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LOC.lat}&longitude=${LOC.lon}&current=pm2_5`);
        const aqiData = await aqiRes.json();

        // Step 3: Fetch 30 Day Trend (The one likely failing)
        const trendRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LOC.lat}&longitude=${LOC.lon}&daily=sunrise,sunset&timezone=auto&forecast_days=30`);
        const trendData = await trendRes.json();

        updateUI(sunData.results, aqiData.current, trendData.daily);
        document.getElementById('loader').style.display = 'none';

    } catch (e) {
        console.error(e);
        document.getElementById('loader-text').innerText = "üì° API Connection Restricted.";
        document.getElementById('force-btn').style.display = 'block';
    }
}

function updateUI(todaySun, aqi, trend) {
    const format = (iso) => new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: false});
    document.getElementById('sr').innerText = format(todaySun.sunrise);
    document.getElementById('ss').innerText = format(todaySun.sunset);
    
    document.getElementById('aqi').innerText = aqi.pm2_5;
    const msg = document.getElementById('aqi-msg');
    msg.innerText = aqi.pm2_5 <= 12 ? "SAFE" : aqi.pm2_5 <= 35 ? "MODERATE" : "UNHEALTHY";
    msg.style.color = aqi.pm2_5 <= 12 ? "#16a34a" : "#d97706";

    startCountdown(todaySun.sunrise, todaySun.sunset);
    renderChart(trend.sunrise, trend.sunset);
}

function renderChart(srArr, ssArr) {
    const labels = srArr.map(d => new Date(d).toLocaleDateString([], {month:'short', day:'numeric'}));
    const toDec = iso => { const d = new Date(iso); return d.getHours() + d.getMinutes()/60; };

    new Chart(document.getElementById('solarChart'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                { label: 'Sunset', data: ssArr.map(toDec), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: 1, tension: 0.3 },
                { label: 'Sunrise', data: srArr.map(toDec), borderColor: '#3b82f6', fill: false, tension: 0.3 }
            ]
        },
        options: {
            scales: { y: { ticks: { callback: v => Math.floor(v).toString().padStart(2,'0')+":00" } } }
        }
    });
}

function startCountdown(sr, ss) {
    setInterval(() => {
        const now = new Date(), sRise = new Date(sr), sSet = new Date(ss);
        let target = now < sRise ? sRise : now < sSet ? sSet : new Date(sRise.getTime() + 86400000);
        let diff = target - now;
        const h = Math.floor(diff/3600000).toString().padStart(2,"0");
        const m = Math.floor((diff%3600000)/60000).toString().padStart(2,"0");
        const s = Math.floor((diff%60000)/1000).toString().padStart(2,"0");
        document.getElementById('cd').innerText = `${h}:${m}:${s}`;
        document.getElementById('cd-label').innerText = now < sRise ? "To Sunrise" : now < sSet ? "To Sunset" : "To Dawn";
    }, 1000);
}

function useOfflineData() {
    // Math-based estimates for Mumbai in case APIs are blocked
    const mockTrend = { 
        sunrise: Array(30).fill("2026-02-22T07:05:00"), 
        sunset: Array(30).fill("2026-02-22T18:35:00") 
    };
    updateUI({sunrise: "2026-02-22T07:05:00", sunset: "2026-02-22T18:35:00"}, {pm2_5: 24}, mockTrend);
    document.getElementById('loader').style.display = 'none';
}

init();
</script>
</body>
</html>
